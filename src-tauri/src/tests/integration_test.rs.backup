// src-tauri/src/tests/integration_test.rs
// é›†æˆæµ‹è¯• - éªŒè¯6ä¸ªAgentçš„å®Œæ•´åä½œå·¥ä½œæµ

use anyhow::Result;
use std::sync::Arc;
use tokio;
use uuid::Uuid;

use crate::agents::{
    Agent, AgentContext, AgentResult, Criticism,
    clarifier::ClarifierAgent,
    innovator::InnovatorAgent, 
    critic::CriticAgent,
    synthesizer::SynthesizerAgent,
    verifier::Ver    let innovation_deltas = match innovator_result {
        AgentResult::Innovation(deltas) => {
            println!("âœ… Innovatoræµ‹è¯•æˆåŠŸï¼Œç”Ÿæˆäº†{}ä¸ªåˆ›æ–°    // éªŒè¯Agenté—´çŠ¶æ€ä¼ é€’
    assert_eq!(iteration_version.session_id, session_id, "ä¼šè¯IDåº”è¯¥ä¿æŒä¸€è‡´");

    println!("âœ… ç®€åŒ–é›†æˆæµ‹è¯•å®Œæˆï¼æ‰€æœ‰6ä¸ªAgentåŸºç¡€åŠŸèƒ½éªŒè¯æˆåŠŸ");
    println!("ğŸ“ˆ æµ‹è¯•ç»“æœæ€»ç»“:");
    println!("   - Clarifier: {}ä¸ªé—®é¢˜", clarification.qa_pairs.len());
    println!("   - Innovator: {}ä¸ªåˆ›æ–°å»ºè®®", innovation_deltas.len()); 
    println!("   - Critic: {}ä¸ªæ‰¹è¯„æ„è§", criticisms.len());
    println!("   - Synthesizer: v{}ç‰ˆæœ¬ï¼Œç½®ä¿¡åº¦{:.1}%", 
        iteration_version.version, iteration_version.confidence * 100.0);
    println!("   - Verifier: é€šè¿‡çŠ¶æ€{}", verification_report.passed);
    println!("   - Summarizer: {}å­—ç¬¦æŠ¥å‘Š", final_summary.len());en());
            deltas
        }
        _ => panic!("Expected Innovation result"),
    };,
    summarizer::SummarizerAgent,
};
use crate::core::{
    data_structures::{
        IdeaSeed, StructuredIdea, Clarification, SlotType, QAPair,
        IterationVersion, VerificationReport, Evidence, FactCheckStatus
    },
};
use crate::config::AppConfig;
use crate::storage::DataStore;

/// ç®€åŒ–ç‰ˆæœ¬çš„Agentå·¥ä½œæµæµ‹è¯•
#[tokio::test]
async fn test_simple_agent_workflow() -> Result<()> {
    println!("ğŸš€ å¼€å§‹ç®€åŒ–é›†æˆæµ‹è¯•ï¼šéªŒè¯å„AgentåŸºç¡€åŠŸèƒ½");

    // 1. è®¾ç½®æµ‹è¯•ç¯å¢ƒ
    let config = Arc::new(tokio::sync::RwLock::new(AppConfig::default()));
    let data_store = Arc::new(DataStore::new().await?);

    // 2. åˆ›å»ºæµ‹è¯•ç”¨çš„åˆå§‹æƒ³æ³•
    let idea_seed = IdeaSeed {
        raw_text: "æˆ‘æƒ³åšä¸€ä¸ªèƒ½å¸®åŠ©å­¦ç”Ÿæé«˜å­¦ä¹ æ•ˆç‡çš„AIåŠ©æ‰‹".to_string(),
        context_hints: vec!["æ•™è‚²ç§‘æŠ€".to_string(), "AIåŠ©æ‰‹".to_string()],
        domain: Some("æ•™è‚²".to_string()),
    };

    let session_id = Uuid::new_v4();
    println!("ğŸ’¡ æµ‹è¯•æƒ³æ³•: {}", idea_seed.raw_text);

    // 3. æµ‹è¯• Clarifier Agent
    println!("\nğŸ“‹ æµ‹è¯• Clarifier Agent...");
    
    let clarifier_context = AgentContext {
        session_id,
        current_version: None,
        clarification: None,
        previous_versions: vec![],
        knowledge_base: vec![],
        previous_results: vec![],
    };

    let clarifier = ClarifierAgent::new(config.clone()).await?;
    let clarifier_result = clarifier.execute(clarifier_context).await?;
    
    let clarification = match clarifier_result {
        AgentResult::Clarification(c) => {
            println!("âœ… Clarifieræµ‹è¯•æˆåŠŸï¼Œç”Ÿæˆäº†{}ä¸ªé—®é¢˜", c.qa_pairs.len());
            c
        }
        _ => panic!("Expected Clarification result"),
    };

    // 4. æµ‹è¯• Innovator Agent
    println!("\nğŸ’¡ æµ‹è¯• Innovator Agent...");
    
    let innovator_context = AgentContext {
        session_id,
        current_version: None,
        clarification: Some(clarification.clone()),
        previous_versions: vec![],
        knowledge_base: vec![],
        previous_results: vec![AgentResult::Clarification(clarification.clone())],
    };

    let innovator = InnovatorAgent::new(config.clone()).await?;
    let innovator_result = innovator.execute(innovator_context).await?;
    
    let innovation_deltas = match innovator_result {
        AgentResult::Innovation(deltas) => {
            println!("âœ… Innovatoræµ‹è¯•æˆåŠŸï¼Œç”Ÿæˆäº†{}ä¸ªåˆ›æ–°å»ºè®®", deltas.len());
            deltas
        }
        _ => panic!("Expected Innovation result"),
    };

    // 5. æµ‹è¯• Critic Agent
    println!("\nğŸ” æµ‹è¯• Critic Agent...");
    
    let critic_context = AgentContext {
        session_id,
        current_version: None,
        clarification: Some(clarification.clone()),
        previous_versions: vec![],
        knowledge_base: vec![],
        previous_results: vec![
            AgentResult::Clarification(clarification.clone()),
            AgentResult::Innovation(innovation_deltas.clone()),
        ],
    };

    let critic = CriticAgent::new(config.clone()).await?;
    let critic_result = critic.execute(critic_context).await?;
    
    let criticisms = match critic_result {
        AgentResult::Criticism(crits) => {
            println!("âœ… Criticæµ‹è¯•æˆåŠŸï¼Œç”Ÿæˆäº†{}ä¸ªæ‰¹è¯„æ„è§", crits.len());
            crits
        }
        _ => panic!("Expected Criticism result"),
    };

    // 6. æµ‹è¯• Synthesizer Agent
    println!("\nğŸ”„ æµ‹è¯• Synthesizer Agent...");
    
    let synthesizer_context = AgentContext {
        session_id,
        current_version: None,
        clarification: Some(clarification.clone()),
        previous_versions: vec![],
        knowledge_base: vec![],
        previous_results: vec![
            AgentResult::Clarification(clarification.clone()),
            AgentResult::Innovation(innovation_deltas.clone()),
            AgentResult::Criticism(criticisms.clone()),
        ],
    };

    let synthesizer = SynthesizerAgent::new(config.clone()).await?;
    let synthesizer_result = synthesizer.execute(synthesizer_context).await?;
    
    let iteration_version = match synthesizer_result {
        AgentResult::Synthesis(iter) => {
            println!("âœ… Synthesizeræµ‹è¯•æˆåŠŸï¼Œç”Ÿæˆç‰ˆæœ¬ v{}", iter.version);
            iter
        }
        _ => panic!("Expected Synthesis result"),
    };

    // 7. æµ‹è¯• Verifier Agent
    println!("\nğŸ” æµ‹è¯• Verifier Agent...");
    
    let verifier_context = AgentContext {
        session_id,
        current_version: Some(iteration_version.clone()),
        clarification: Some(clarification.clone()),
        previous_versions: vec![],
        knowledge_base: vec![],
        previous_results: vec![
            AgentResult::Clarification(clarification.clone()),
            AgentResult::Innovation(innovation_deltas.clone()),
            AgentResult::Criticism(criticisms.clone()),
            AgentResult::Iteration(iteration_version.clone()),
        ],
    };

    let verifier = VerifierAgent::new(config.clone(), data_store.clone()).await?;
    let verifier_result = verifier.execute(verifier_context).await?;
    
    let verification_report = match verifier_result {
        AgentResult::Verification(report) => {
            println!("âœ… Verifieræµ‹è¯•æˆåŠŸï¼ŒéªŒè¯çŠ¶æ€: {}", report.passed);
            report
        }
        _ => panic!("Expected Verification result"),
    };

    // 8. æµ‹è¯• Summarizer Agent
    println!("\nğŸ“Š æµ‹è¯• Summarizer Agent...");
    
    let summarizer_context = AgentContext {
        session_id,
        current_version: Some(iteration_version.clone()),
        clarification: Some(clarification.clone()),
        previous_versions: vec![],
        knowledge_base: vec![],
        previous_results: vec![
            AgentResult::Clarification(clarification.clone()),
            AgentResult::Innovation(innovation_deltas.clone()),
            AgentResult::Criticism(criticisms.clone()),
            AgentResult::Iteration(iteration_version.clone()),
            AgentResult::Verification(verification_report.clone()),
        ],
    };

    let summarizer = SummarizerAgent::new(config.clone()).await?;
    let summarizer_result = summarizer.execute(summarizer_context).await?;
    
    let final_summary = match summarizer_result {
        AgentResult::Summary(summary) => {
            println!("âœ… Summarizeræµ‹è¯•æˆåŠŸï¼Œç”ŸæˆæŠ¥å‘Šé•¿åº¦: {} å­—ç¬¦", summary.len());
            summary
        }
        _ => panic!("Expected Summary result"),
    };

    // 9. éªŒè¯å®Œæ•´æ€§
    println!("\nğŸ å·¥ä½œæµå®Œæ•´æ€§éªŒè¯...");
    
    // éªŒè¯æ•°æ®æµè¿è´¯æ€§
    assert!(!clarification.qa_pairs.is_empty(), "æ¾„æ¸…é˜¶æ®µåº”è¯¥ç”Ÿæˆé—®é¢˜");
    assert!(!innovation_deltas.is_empty(), "åˆ›æ–°é˜¶æ®µåº”è¯¥ç”Ÿæˆå»ºè®®");
    assert!(!criticisms.is_empty(), "æ‰¹è¯„é˜¶æ®µåº”è¯¥ç”Ÿæˆæ‰¹è¯„");
    assert!(iteration_version.version > 0, "ç»¼åˆé˜¶æ®µåº”è¯¥ç”Ÿæˆç‰ˆæœ¬");
    assert!(!final_summary.is_empty(), "æ€»ç»“é˜¶æ®µåº”è¯¥ç”ŸæˆæŠ¥å‘Š");

    // éªŒè¯Agenté—´çŠ¶æ€ä¼ é€’
    assert_eq!(iteration_version.session_id, session_id, "ä¼šè¯IDåº”è¯¥ä¿æŒä¸€è‡´");

    println!("âœ… ç®€åŒ–é›†æˆæµ‹è¯•å®Œæˆï¼æ‰€æœ‰6ä¸ªAgentåŸºç¡€åŠŸèƒ½éªŒè¯æˆåŠŸ");
    println!("ğŸ“ˆ æµ‹è¯•ç»“æœæ€»ç»“:");
    println!("   - Clarifier: {}ä¸ªé—®é¢˜", clarification.qa_pairs.len());
    println!("   - Innovator: {}ä¸ªåˆ›æ–°å»ºè®®", innovation_deltas.len()); 
    println!("   - Critic: {}ä¸ªæ‰¹è¯„æ„è§", criticisms.len());
    println!("   - Synthesizer: v{}ç‰ˆæœ¬ï¼Œç½®ä¿¡åº¦{:.1}%", 
        iteration_version.version, iteration_version.confidence * 100.0);
    println!("   - Verifier: é€šè¿‡çŠ¶æ€{:?}", verification_report.overall_pass);
    println!("   - Summarizer: {}å­—ç¬¦æŠ¥å‘Š", final_summary.len());

    Ok(())
}

/// æµ‹è¯•AgentåŸºæœ¬æ„é€ å’Œèƒ½åŠ›
#[tokio::test]
async fn test_agent_construction() -> Result<()> {
    println!("ğŸ”§ å¼€å§‹æµ‹è¯•ï¼šAgentæ„é€ å’ŒåŸºç¡€èƒ½åŠ›");

    let config = Arc::new(tokio::sync::RwLock::new(AppConfig::default()));
    let data_store = Arc::new(DataStore::new().await?);

    // æµ‹è¯•æ‰€æœ‰Agentçš„æ„é€ 
    let clarifier = ClarifierAgent::new(config.clone()).await?;
    println!("âœ… ClarifierAgentæ„é€ æˆåŠŸ");
    
    let innovator = InnovatorAgent::new(config.clone()).await?;
    println!("âœ… InnovatorAgentæ„é€ æˆåŠŸ");
    
    let critic = CriticAgent::new(config.clone()).await?;
    println!("âœ… CriticAgentæ„é€ æˆåŠŸ");
    
    let synthesizer = SynthesizerAgent::new(config.clone()).await?;
    println!("âœ… SynthesizerAgentæ„é€ æˆåŠŸ");
    
    let verifier = VerifierAgent::new(config.clone(), data_store.clone()).await?;
    println!("âœ… VerifierAgentæ„é€ æˆåŠŸ");
    
    let summarizer = SummarizerAgent::new(config.clone()).await?;
    println!("âœ… SummarizerAgentæ„é€ æˆåŠŸ");

    // æµ‹è¯•Agentèƒ½åŠ›
    assert_eq!(clarifier.name(), "ClarifierAgent");
    assert_eq!(innovator.name(), "InnovatorAgent");
    assert_eq!(critic.name(), "CriticAgent");
    assert_eq!(synthesizer.name(), "SynthesizerAgent");
    assert_eq!(verifier.name(), "VerifierAgent");
    assert_eq!(summarizer.name(), "SummarizerAgent");

    println!("âœ… Agentæ„é€ æµ‹è¯•å®Œæˆï¼");
    Ok(())
}

/// æµ‹è¯•é”™è¯¯å¤„ç†
#[tokio::test]
async fn test_error_handling() -> Result<()> {
    println!("ğŸš¨ å¼€å§‹æµ‹è¯•ï¼šé”™è¯¯å¤„ç†æœºåˆ¶");

    let config = Arc::new(tokio::sync::RwLock::new(AppConfig::default()));

    // æµ‹è¯•ç©ºè¾“å…¥çš„å¤„ç†
    let empty_context = AgentContext {
        session_id: Uuid::new_v4(),
        current_version: None,
        clarification: None,
        previous_versions: vec![],
        knowledge_base: vec![],
        previous_results: vec![],
    };

    let clarifier = ClarifierAgent::new(config.clone()).await?;
    let result = clarifier.execute(empty_context).await;
    
    match result {
        Ok(_) => println!("âœ… ç©ºè¾“å…¥å¤„ç†æ­£å¸¸"),
        Err(e) => println!("âš ï¸  ç©ºè¾“å…¥é”™è¯¯å¤„ç†: {}", e),
    }

    println!("âœ… é”™è¯¯å¤„ç†æµ‹è¯•å®Œæˆ");
    Ok(())
}

/// å®Œæ•´çš„6-Agentåä½œå·¥ä½œæµé›†æˆæµ‹è¯•
#[tokio::test]
async fn test_complete_agent_workflow() -> Result<()> {
    println!("ğŸš€ å¼€å§‹é›†æˆæµ‹è¯•ï¼šå®Œæ•´çš„6-Agentåä½œå·¥ä½œæµ");

    // 1. è®¾ç½®æµ‹è¯•ç¯å¢ƒ
    let config = Arc::new(tokio::sync::RwLock::new(AppConfig::default()));
    let data_store = Arc::new(DataStore::new().await?);
    let mut runtime = AgentRuntime::new(config.clone(), data_store.clone());

    // æ³¨å†Œæ‰€æœ‰6ä¸ªAgent
    runtime.register_agent(Box::new(ClarifierAgent::new(config.clone()).await?)).await?;
    runtime.register_agent(Box::new(InnovatorAgent::new(config.clone()).await?)).await?;
    runtime.register_agent(Box::new(CriticAgent::new(config.clone()).await?)).await?; 
    runtime.register_agent(Box::new(SynthesizerAgent::new(config.clone()).await?)).await?;
    runtime.register_agent(Box::new(VerifierAgent::new(config.clone(), data_store.clone()).await?)).await?;
    runtime.register_agent(Box::new(SummarizerAgent::new(config.clone()).await?)).await?;

    // 2. åˆ›å»ºæµ‹è¯•ç”¨çš„åˆå§‹æƒ³æ³•
    let idea_seed = IdeaSeed {
        raw_text: "æˆ‘æƒ³åšä¸€ä¸ªèƒ½å¸®åŠ©å­¦ç”Ÿæé«˜å­¦ä¹ æ•ˆç‡çš„AIåŠ©æ‰‹ï¼Œä½†ä¸å¤ªç¡®å®šå…·ä½“åŠŸèƒ½å’Œå®ç°æ–¹å¼".to_string(),
        context_hints: vec!["æ•™è‚²ç§‘æŠ€".to_string(), "AIåŠ©æ‰‹".to_string()],
        domain: Some("æ•™è‚²".to_string()),
    };

    let session_id = Uuid::new_v4();
    println!("ğŸ’¡ æµ‹è¯•æƒ³æ³•: {}", idea_seed.raw_text);

    // 3. é˜¶æ®µ1: Clarifier Agent - æ¾„æ¸…æƒ³æ³•
    println!("\nğŸ“‹ é˜¶æ®µ1: Clarifier Agent å¼€å§‹æ¾„æ¸…æƒ³æ³•...");
    
    let clarifier_context = AgentContext {
        session_id,
        current_version: None,
        clarification: None,
        previous_versions: vec![],
        knowledge_base: vec![],
        previous_results: vec![],
    };

    let clarifier = ClarifierAgent::new(config.clone()).await?;
    let clarifier_result = clarifier.execute(clarifier_context).await?;
    
    let clarification = match clarifier_result {
        AgentResult::Clarification(c) => {
            println!("âœ… Clarifierå®Œæˆï¼Œç”Ÿæˆäº†{}ä¸ªé—®é¢˜", c.qa_pairs.len());
            for (i, qa) in c.qa_pairs.iter().enumerate() {
                println!("   Q{}: {}", i+1, qa.question);
            }
            c
        }
        _ => panic!("Expected Clarification result"),
    };

    // 4. é˜¶æ®µ2: Innovator Agent - ç”Ÿæˆåˆ›æ–°å»ºè®®  
    println!("\nğŸ’¡ é˜¶æ®µ2: Innovator Agent å¼€å§‹ç”Ÿæˆåˆ›æ–°å»ºè®®...");
    
    let innovator_context = AgentContext {
        session_id,
        current_version: None,
        clarification: Some(clarification.clone()),
        previous_versions: vec![],
        knowledge_base: vec![],
        previous_results: vec![AgentResult::Clarification(clarification.clone())],
    };

    let innovator = InnovatorAgent::new(config.clone()).await?;
    let innovator_result = innovator.execute(innovator_context).await?;
    
    let innovation_deltas = match innovator_result {
        AgentResult::Innovation(deltas) => {
            println!("âœ… Innovatorå®Œæˆï¼Œç”Ÿæˆäº†{}ä¸ªåˆ›æ–°å»ºè®®", deltas.len());
            for (i, delta) in deltas.iter().enumerate() {
                println!("   Delta{}: è¯„åˆ†{:.1}", i+1, delta.overall_score());
            }
            deltas
        }
        _ => panic!("Expected Innovation result"),
    };

    // 5. é˜¶æ®µ3: Critic Agent - æ‰¹è¯„åˆ†æ
    println!("\nğŸ” é˜¶æ®µ3: Critic Agent å¼€å§‹æ‰¹è¯„åˆ†æ...");
    
    let critic_context = AgentContext {
        session_id,
        current_version: None,
        clarification: Some(clarification.clone()),
        previous_versions: vec![],
        knowledge_base: vec![],
        previous_results: vec![
            AgentResult::Clarification(clarification.clone()),
            AgentResult::Innovation(innovation_deltas.clone()),
        ],
    };

    let critic = CriticAgent::new(config.clone()).await?;
    let critic_result = critic.execute(critic_context).await?;
    
    let criticisms = match critic_result {
        AgentResult::Criticism(crits) => {
            println!("âœ… Criticå®Œæˆï¼Œç”Ÿæˆäº†{}ä¸ªæ‰¹è¯„æ„è§", crits.len());
            for (i, crit) in crits.iter().enumerate() {
                println!("   æ‰¹è¯„{}: ä¸¥é‡ç¨‹åº¦{}/10", i+1, crit.severity);
            }
            crits
        }
        _ => panic!("Expected Criticism result"),
    };

    // 6. é˜¶æ®µ4: Synthesizer Agent - ç»¼åˆå½’å¹¶
    println!("\nğŸ”„ é˜¶æ®µ4: Synthesizer Agent å¼€å§‹ç»¼åˆå½’å¹¶...");
    
    let synthesizer_context = AgentContext {
        session_id,
        current_version: None,
        clarification: Some(clarification.clone()),
        previous_versions: vec![],
        knowledge_base: vec![],
        previous_results: vec![
            AgentResult::Clarification(clarification.clone()),
            AgentResult::Innovation(innovation_deltas.clone()),
            AgentResult::Criticism(criticisms.clone()),
        ],
    };

    let synthesizer = SynthesizerAgent::new(config.clone()).await?;
    let synthesizer_result = synthesizer.execute(synthesizer_context).await?;
    
    let iteration_version = match synthesizer_result {
        AgentResult::Iteration(iter) => {
            println!("âœ… Synthesizerå®Œæˆï¼Œç”Ÿæˆè¿­ä»£ç‰ˆæœ¬ v{}", iter.version);
            println!("   ç½®ä¿¡åº¦: {:.1}%", iter.confidence * 100.0);
            iter
        }
        _ => panic!("Expected Iteration result"),
    };

    // 7. é˜¶æ®µ5: Verifier Agent - éªŒè¯è´¨é‡  
    println!("\nğŸ” é˜¶æ®µ5: Verifier Agent å¼€å§‹éªŒè¯è´¨é‡...");
    
    let verifier_context = AgentContext {
        session_id,
        current_version: Some(iteration_version.clone()),
        clarification: Some(clarification.clone()),
        previous_versions: vec![],
        knowledge_base: vec![],
        previous_results: vec![
            AgentResult::Clarification(clarification.clone()),
            AgentResult::Innovation(innovation_deltas.clone()),
            AgentResult::Criticism(criticisms.clone()),
            AgentResult::Iteration(iteration_version.clone()),
        ],
    };

    let verifier = VerifierAgent::new(config.clone(), data_store.clone()).await?;
    let verifier_result = verifier.execute(verifier_context).await?;
    
    let verification_report = match verifier_result {
        AgentResult::Verification(report) => {
            println!("âœ… Verifierå®Œæˆï¼ŒéªŒè¯çŠ¶æ€: {:?}", report.overall_pass);
            println!("   é€»è¾‘æ£€æŸ¥: {}, äº‹å®æ£€æŸ¥: {}", 
                report.logic_check_passed, report.fact_check_passed);
            report
        }
        _ => panic!("Expected Verification result"),
    };

    // 8. é˜¶æ®µ6: Summarizer Agent - ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š
    println!("\nğŸ“Š é˜¶æ®µ6: Summarizer Agent å¼€å§‹ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š...");
    
    let summarizer_context = AgentContext {
        session_id,
        current_version: Some(iteration_version.clone()),
        clarification: Some(clarification.clone()),
        previous_versions: vec![],
        knowledge_base: vec![],
        previous_results: vec![
            AgentResult::Clarification(clarification.clone()),
            AgentResult::Innovation(innovation_deltas.clone()),
            AgentResult::Criticism(criticisms.clone()),
            AgentResult::Iteration(iteration_version.clone()),
            AgentResult::Verification(verification_report.clone()),
        ],
    };

    let summarizer = SummarizerAgent::new(config.clone()).await?;
    let summarizer_result = summarizer.execute(summarizer_context).await?;
    
    let final_summary = match summarizer_result {
        AgentResult::Summary(summary) => {
            println!("âœ… Summarizerå®Œæˆï¼Œç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š");
            println!("   æŠ¥å‘Šé•¿åº¦: {} å­—ç¬¦", summary.len());
            println!("   å‰100å­—ç¬¦é¢„è§ˆ: {}", 
                &summary.chars().take(100).collect::<String>());
            summary
        }
        _ => panic!("Expected Summary result"),
    };

    // 9. éªŒè¯å®Œæ•´æ€§
    println!("\nğŸ å·¥ä½œæµå®Œæ•´æ€§éªŒè¯...");
    
    // éªŒè¯æ•°æ®æµè¿è´¯æ€§
    assert!(!clarification.qa_pairs.is_empty(), "æ¾„æ¸…é˜¶æ®µåº”è¯¥ç”Ÿæˆé—®é¢˜");
    assert!(!innovation_deltas.is_empty(), "åˆ›æ–°é˜¶æ®µåº”è¯¥ç”Ÿæˆå»ºè®®");
    assert!(!criticisms.is_empty(), "æ‰¹è¯„é˜¶æ®µåº”è¯¥ç”Ÿæˆæ‰¹è¯„");
    assert!(iteration_version.version > 0, "ç»¼åˆé˜¶æ®µåº”è¯¥ç”Ÿæˆç‰ˆæœ¬");
    assert!(!final_summary.is_empty(), "æ€»ç»“é˜¶æ®µåº”è¯¥ç”ŸæˆæŠ¥å‘Š");

    // éªŒè¯Agenté—´çŠ¶æ€ä¼ é€’
    assert_eq!(iteration_version.session_id, session_id, "ä¼šè¯IDåº”è¯¥ä¿æŒä¸€è‡´");
    assert!(verification_report.overall_pass.is_some(), "éªŒè¯æŠ¥å‘Šåº”è¯¥æœ‰æ€»ä½“çŠ¶æ€");

    println!("âœ… é›†æˆæµ‹è¯•å®Œæˆï¼æ‰€æœ‰6ä¸ªAgentæˆåŠŸåä½œå®Œæˆå·¥ä½œæµ");
    println!("ğŸ“ˆ æµ‹è¯•ç»“æœæ€»ç»“:");
    println!("   - Clarifier: {}ä¸ªé—®é¢˜", clarification.qa_pairs.len());
    println!("   - Innovator: {}ä¸ªåˆ›æ–°å»ºè®®", innovation_deltas.len()); 
    println!("   - Critic: {}ä¸ªæ‰¹è¯„æ„è§", criticisms.len());
    println!("   - Synthesizer: v{}ç‰ˆæœ¬ï¼Œç½®ä¿¡åº¦{:.1}%", 
        iteration_version.version, iteration_version.confidence * 100.0);
    println!("   - Verifier: é€šè¿‡çŠ¶æ€{:?}", verification_report.overall_pass);
    println!("   - Summarizer: {}å­—ç¬¦æŠ¥å‘Š", final_summary.len());

    Ok(())
}

/// æµ‹è¯•é”™è¯¯å¤„ç†
#[tokio::test]
async fn test_error_handling() -> Result<()> {
    println!("ï¿½ å¼€å§‹æµ‹è¯•ï¼šé”™è¯¯å¤„ç†æœºåˆ¶");

    let config = Arc::new(tokio::sync::RwLock::new(AppConfig::default()));

    // æµ‹è¯•ç©ºè¾“å…¥çš„å¤„ç†
    let empty_context = AgentContext {
        session_id: Uuid::new_v4(),
        current_version: None,
        clarification: None,
        previous_versions: vec![],
        knowledge_base: vec![],
        previous_results: vec![],
    };

    let clarifier = ClarifierAgent::new(config.clone()).await?;
    let result = clarifier.execute(empty_context).await;
    
    match result {
        Ok(_) => println!("âœ… ç©ºè¾“å…¥å¤„ç†æ­£å¸¸"),
        Err(e) => println!("âš ï¸  ç©ºè¾“å…¥é”™è¯¯å¤„ç†: {}", e),
    }

    println!("âœ… é”™è¯¯å¤„ç†æµ‹è¯•å®Œæˆ");
    Ok(())
}
